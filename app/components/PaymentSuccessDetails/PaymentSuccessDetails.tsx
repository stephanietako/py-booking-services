// 3. Composant PaymentSuccessDetails modifi√©
// // app/components/PaymentSuccessDetails/PaymentSuccessDetails.tsx
// "use client";

// import { useEffect, useState } from "react";
// import { format } from "date-fns";
// import { fr } from "date-fns/locale";
// import { BookingWithDetails } from "@/types";
// // Styles
// import styles from "./styles.module.scss";

// interface PaymentSuccessDetailsProps {
//   token: string;
// }

// export default function PaymentSuccessDetails({
//   token,
// }: PaymentSuccessDetailsProps) {
//   const [booking, setBooking] = useState<BookingWithDetails | null>(null);
//   const [loading, setLoading] = useState(true);
//   const [error, setError] = useState<string | null>(null);

//   useEffect(() => {
//     const fetchBookingDetails = async () => {
//       try {
//         const response = await fetch("/api/bookings/verify-token", {
//           method: "POST",
//           headers: { "Content-Type": "application/json" },
//           body: JSON.stringify({ token }),
//         });

//         if (!response.ok) {
//           const errorData = await response.json();
//           throw new Error(errorData.error || "Erreur de v√©rification");
//         }

//         const { data } = await response.json();
//         setBooking(data);
//       } catch (err) {
//         console.error("Erreur lors de la r√©cup√©ration:", err);
//         setError(
//           err instanceof Error
//             ? err.message
//             : "Erreur lors du chargement des d√©tails"
//         );
//       } finally {
//         setLoading(false);
//       }
//     };

//     fetchBookingDetails();
//   }, [token]);

//   if (loading) {
//     return (
//       <div className={styles.loading}>
//         <p>üîÑ Chargement des d√©tails de votre r√©servation...</p>
//       </div>
//     );
//   }

//   if (error || !booking) {
//     return (
//       <div className="error">
//         <p>‚ùå {error || "R√©servation introuvable"}</p>
//         <p>Le lien de confirmation a peut-√™tre expir√©.</p>
//       </div>
//     );
//   }

//   const customerName =
//     booking.client?.fullName || booking.user?.name || "Client";
//   const customerEmail = booking.client?.email || booking.user?.email || "";

//   // Calculer le montant pay√© en ligne
//   const paidOnline = booking.totalAmount - booking.payableOnBoard;

//   return (
//     <div className={styles.booking_details}>
//       <div className={styles.booking_summary}>
//         <h2>üìß R√©capitulatif de votre r√©servation</h2>

//         <div className={styles.customer_info}>
//           <h3>üë§ Informations client</h3>
//           <p>
//             <strong>Nom:</strong> {customerName}
//           </p>
//           <p>
//             <strong>Email:</strong> {customerEmail}
//           </p>
//           {booking.phoneNumber && (
//             <p>
//               <strong>T√©l√©phone:</strong> {booking.phoneNumber}
//             </p>
//           )}
//         </div>

//         <div className={styles.service_info}>
//           <h3>üö§ Service r√©serv√©</h3>
//           <p>
//             <strong>{booking.service?.name}</strong>
//           </p>
//           <p>
//             <strong>Date:</strong>{" "}
//             {format(new Date(booking.reservedAt), "dd MMMM yyyy", {
//               locale: fr,
//             })}
//           </p>
//           <p>
//             <strong>Horaire:</strong>{" "}
//             {format(new Date(booking.startTime), "HH:mm")} -{" "}
//             {format(new Date(booking.endTime), "HH:mm")}
//           </p>
//           {booking.withCaptain && (
//             <p>
//               üë®‚Äç‚úàÔ∏è <strong>Avec capitaine</strong>
//             </p>
//           )}
//         </div>

//         {booking.bookingOptions && booking.bookingOptions.length > 0 && (
//           <div className={styles.options_info}>
//             <h3>üéØ Options s√©lectionn√©es</h3>
//             {booking.bookingOptions.map((option, index) => (
//               <div key={index} className={styles.option_item}>
//                 <p>
//                   ‚Ä¢ {option.label} x{option.quantity} - {option.amount}‚Ç¨
//                 </p>
//               </div>
//             ))}
//           </div>
//         )}

//         <div className={styles.payment_info}>
//           <h3>üí≥ D√©tails du paiement</h3>
//           <p>
//             <strong>Montant du bateau:</strong> {booking.boatAmount}‚Ç¨
//           </p>
//           <p>
//             <strong>üí∞ Pay√© en ligne:</strong> {paidOnline}‚Ç¨
//           </p>
//           {booking.payableOnBoard > 0 && (
//             <p>
//               <strong>üè™ √Ä payer sur place:</strong> {booking.payableOnBoard}‚Ç¨
//             </p>
//           )}
//           <p>
//             <strong>Total:</strong> {booking.totalAmount}‚Ç¨
//           </p>
//         </div>

//         <div className={styles.next_steps}>
//           <h3>üìù Prochaines √©tapes</h3>
//           <ul>
//             <li>‚úÖ Votre paiement a √©t√© confirm√©</li>
//             <li>üìß Un email de confirmation va vous √™tre envoy√©</li>
//             <li>üìû Nous vous contacterons pour finaliser les d√©tails</li>
//             {booking.payableOnBoard > 0 && (
//               <li>üí∞ {booking.payableOnBoard}‚Ç¨ √† r√©gler sur place le jour J</li>
//             )}
//           </ul>
//         </div>

//         {/* Plus d'IDs sensibles affich√©s */}
//         <div
//           className={styles.booking_ref}
//           style={{ fontSize: "0.8em", color: "#666", marginTop: "20px" }}
//         >
//           <p>R√©f√©rence r√©servation: #{booking.id}</p>
//         </div>
//       </div>
//     </div>
//   );
// }
// app/components/PaymentSuccessDetails/PaymentSuccessDetails.tsx
"use client";

import { useEffect, useState } from "react";
import toast from "react-hot-toast";
import { format } from "date-fns";
import { fr } from "date-fns/locale";
import styles from "./styles.module.scss";

import type { BookingWithDetails } from "@/types"; // adapte le chemin si besoin

interface PaymentSuccessDetailsProps {
  token: string;
}

export default function PaymentSuccessDetails({
  token,
}: PaymentSuccessDetailsProps) {
  const [booking, setBooking] = useState<BookingWithDetails | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchBookingDetails = async () => {
      try {
        const response = await fetch("/api/bookings/verify-token", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token }),
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || "Erreur de v√©rification");
        }

        const json: { data: BookingWithDetails } = await response.json();
        setBooking(json.data);

        toast.success("üéâ Paiement confirm√© avec succ√®s !");
      } catch (err) {
        setError(
          err instanceof Error
            ? err.message
            : "Erreur lors du chargement des d√©tails"
        );
      } finally {
        setLoading(false);
      }
    };

    fetchBookingDetails();
  }, [token]);

  if (loading) {
    return (
      <div className={styles.loading}>
        <p>üîÑ Chargement des d√©tails de votre r√©servation...</p>
      </div>
    );
  }

  if (error || !booking) {
    return (
      <div className="error">
        <p>‚ùå {error || "R√©servation introuvable"}</p>
        <p>Le lien de confirmation a peut-√™tre expir√©.</p>
      </div>
    );
  }

  const customerName =
    booking.clientFullName ||
    booking.user?.fullName ||
    booking.user?.name ||
    "Client";
  const customerEmail = booking.clientEmail || booking.user?.email || "";
  const paidOnline = booking.totalAmount - booking.payableOnBoard;

  return (
    <div className={styles.booking_details}>
      <div className={styles.booking_summary}>
        <h2>üìß R√©capitulatif de votre r√©servation</h2>

        <div className={styles.customer_info}>
          <h3>üë§ Informations client</h3>
          <p>
            <strong>Nom:</strong> {customerName}
          </p>
          <p>
            <strong>Email:</strong> {customerEmail}
          </p>
          {booking.clientPhoneNumber && (
            <p>
              <strong>T√©l√©phone:</strong> {booking.clientPhoneNumber}
            </p>
          )}
        </div>

        <div className={styles.service_info}>
          <h3>üö§ Service r√©serv√©</h3>
          <p>
            <strong>{booking.service?.name}</strong>
          </p>
          <p>
            <strong>Date:</strong>{" "}
            {format(new Date(booking.reservedAt), "dd MMMM yyyy", {
              locale: fr,
            })}
          </p>
          <p>
            <strong>Horaire:</strong>{" "}
            {format(new Date(booking.startTime), "HH:mm")} -{" "}
            {format(new Date(booking.endTime), "HH:mm")}
          </p>
          {booking.withCaptain && (
            <p>
              üë®‚Äç‚úàÔ∏è <strong>Avec capitaine</strong>
            </p>
          )}
        </div>

        {booking.bookingOptions.length > 0 && (
          <div className={styles.options_info}>
            <h3>üéØ Options s√©lectionn√©es</h3>
            {booking.bookingOptions.map(({ label, quantity, amount, id }) => (
              <div key={id} className={styles.option_item}>
                <p>
                  ‚Ä¢ {label} x{quantity} - {amount}‚Ç¨
                </p>
              </div>
            ))}
          </div>
        )}

        <div className={styles.payment_info}>
          <h3>üí≥ D√©tails du paiement</h3>
          <p>
            <strong>Montant du bateau:</strong> {booking.boatAmount}‚Ç¨
          </p>
          <p>
            <strong>üí∞ Pay√© en ligne:</strong> {paidOnline}‚Ç¨
          </p>
          {booking.payableOnBoard > 0 && (
            <p>
              <strong>üè™ √Ä payer sur place:</strong> {booking.payableOnBoard}‚Ç¨
            </p>
          )}
          <p>
            <strong>Total:</strong> {booking.totalAmount}‚Ç¨
          </p>
        </div>

        <div className={styles.next_steps}>
          <h3>üìù Prochaines √©tapes</h3>
          <ul>
            <li>‚úÖ Votre paiement a √©t√© confirm√©</li>
            <li>üìß Un email de confirmation va vous √™tre envoy√©</li>
            <li>üìû Nous vous contacterons pour finaliser les d√©tails</li>
            {booking.payableOnBoard > 0 && (
              <li>üí∞ {booking.payableOnBoard}‚Ç¨ √† r√©gler sur place le jour J</li>
            )}
          </ul>
        </div>

        <div
          className={styles.booking_ref}
          style={{ fontSize: "0.8em", color: "#666", marginTop: "20px" }}
        >
          <p>R√©f√©rence r√©servation: #{booking.id}</p>
        </div>
      </div>
    </div>
  );
}
